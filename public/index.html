<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attribution de chambres / Room Assignment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .language-switcher {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .flag-btn {
            cursor: pointer;
            font-size: 2rem;
            padding: 5px;
            border: 2px solid transparent;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .flag-btn:hover {
            transform: scale(1.1);
        }

        .flag-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        h1 {
            font-size: 2rem;
            color: #333;
        }

        .stats {
            font-size: 1.1rem;
            color: #666;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            font-size: 0.75rem;
            padding: 6px 12px;
        }

        .admin-panel {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .admin-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .participant-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .participant-item:last-child {
            border-bottom: none;
        }

        .participant-item input {
            flex: 1;
            margin-right: 10px;
        }

        .participant-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .inscription-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .member-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .member-row {
            display: flex;
            gap: 10px;
        }

        .member-row select {
            flex: 1;
        }

        .gender-preference {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .gender-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .info-box {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.9rem;
            color: #92400e;
            margin-top: 10px;
        }

        .rooms-grid {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .room-type-section {
            margin-bottom: 40px;
        }

        .room-type-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .rooms-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .room-card {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .room-card.available {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .room-card.full {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .room-card.female-pref {
            background: #fce7f3;
            border-color: #f9a8d4;
        }

        .room-card.male-pref {
            background: #dbeafe;
            border-color: #93c5fd;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .room-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .badge-female {
            background: #fce7f3;
            color: #be185d;
        }

        .badge-mixed {
            background: #e5e7eb;
            color: #6b7280;
        }

        .badge-male {
            background: #dbeafe;
            color: #1e40af;
        }

        .occupants-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .occupant-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .empty-bed {
            background: white;
            padding: 10px;
            border-radius: 6px;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-block {
            width: 100%;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5rem;
            color: white;
        }

        .room-config-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .room-config-item input {
            width: auto;
            flex: 1;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            color: #065f46;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table th, table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        table th {
            background: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="loading">‚è≥ <span class="loading-text">Chargement...</span></div>
    </div>

    <script>
        let appData = { rooms: [], participants: [], registrationCodes: {}, totalCapacity: 0 };
        let isAdmin = false;
        let roomToModify = null;
        let currentLang = 'fr';

        const translations = {
            fr: {
                title: 'Attribution de chambres',
                adminMode: 'Mode Admin',
                quitAdmin: 'Quitter Admin',
                participantsRegistered: 'participants inscrits',
                loading: 'Chargement...',
                administration: 'Administration',
                importCSV: 'Importer Excel/CSV',
                exportResults: 'Exporter les r√©sultats',
                participantsLoaded: 'participants charg√©s',
                totalCapacity: 'Capacit√© totale',
                beds: 'lits',
                participantsList: 'Liste des participants',
                add: 'Ajouter',
                noParticipants: 'Aucun participant. Importez un fichier CSV ou ajoutez-les manuellement.',
                registered: 'Inscrit',
                modify: 'Modifier',
                delete: 'Supprimer',
                clearAll: 'Effacer toute la liste',
                roomManagement: 'Gestion des chambres',
                editRooms: 'Modifier les chambres',
                inscription: 'Inscription',
                selectRoom: 'S√©lectionnez une chambre disponible',
                chooseRoom: '-- Choisir une chambre --',
                room: 'Chambre n¬∞',
                placesRemaining: 'places restantes',
                groupMembers: 'Membres du groupe',
                chooseParticipant: '-- Choisir un participant --',
                addMember: 'Ajouter un membre',
                roomPreference: 'Pr√©f√©rence de chambre (premi√®re r√©servation uniquement)',
                mixed: 'Mixte',
                femalesOnly: 'Femmes uniquement',
                malesOnly: 'Hommes uniquement',
                preferenceInfo: 'Note : Cette pr√©f√©rence peut ne pas √™tre respect√©e selon le nombre d\'hommes et de femmes du voyage et la capacit√© des chambres.',
                confirmInscription: 'Confirmer l\'inscription',
                rooms: 'Chambres',
                roomsCount: 'chambres',
                people: 'personnes',
                deleteMyGroup: 'Supprimer mon groupe',
                availableBed: 'Lit disponible',
                adminLogin: 'Connexion Admin',
                adminCode: 'Code admin',
                login: 'Connexion',
                cancel: 'Annuler',
                modifyInscription: 'Modifier votre inscription',
                enterCode: 'Entrez le code re√ßu lors de votre inscription.',
                codeExample: 'CODE (ex: AB12CD)',
                confirm: 'Confirmer'
            },
            en: {
                title: 'Room Assignment',
                adminMode: 'Admin Mode',
                quitAdmin: 'Quit Admin',
                participantsRegistered: 'participants registered',
                loading: 'Loading...',
                administration: 'Administration',
                importCSV: 'Import Excel/CSV',
                exportResults: 'Export results',
                participantsLoaded: 'participants loaded',
                totalCapacity: 'Total capacity',
                beds: 'beds',
                participantsList: 'Participants list',
                add: 'Add',
                noParticipants: 'No participants. Import a CSV file or add them manually.',
                registered: 'Registered',
                modify: 'Edit',
                delete: 'Delete',
                clearAll: 'Clear entire list',
                roomManagement: 'Room Management',
                editRooms: 'Edit rooms',
                inscription: 'Registration',
                selectRoom: 'Select an available room',
                chooseRoom: '-- Choose a room --',
                room: 'Room #',
                placesRemaining: 'places remaining',
                groupMembers: 'Group members',
                chooseParticipant: '-- Choose a participant --',
                addMember: 'Add member',
                roomPreference: 'Room preference (first reservation only)',
                mixed: 'Mixed',
                femalesOnly: 'Females only',
                malesOnly: 'Males only',
                preferenceInfo: 'Note: This preference may not be respected depending on the number of men and women in the trip and room capacity.',
                confirmInscription: 'Confirm registration',
                rooms: 'Rooms',
                roomsCount: 'rooms',
                people: 'people',
                deleteMyGroup: 'Delete my group',
                availableBed: 'Available bed',
                adminLogin: 'Admin Login',
                adminCode: 'Admin code',
                login: 'Login',
                cancel: 'Cancel',
                modifyInscription: 'Modify your registration',
                enterCode: 'Enter the code received during your registration.',
                codeExample: 'CODE (e.g.: AB12CD)',
                confirm: 'Confirm'
            }
        };

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function switchLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.flag-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-lang="${lang}"]`).classList.add('active');
            renderApp();
        }

        // Load data
        async function loadData() {
            try {
                const response = await fetch('/api/data');
                appData = await response.json();
                renderApp();
            } catch (error) {
                alert('Erreur de chargement : ' + error.message);
            }
        }

        // Assign group
        async function assignGroup() {
            const roomId = document.getElementById('roomSelect').value;
            if (!roomId) {
                alert(currentLang === 'fr' ? 'Veuillez s√©lectionner une chambre' : 'Please select a room');
                return;
            }

            const selects = document.querySelectorAll('.member-select');
            const members = Array.from(selects).map(s => s.value).filter(m => m);

            if (members.length === 0) {
                alert(currentLang === 'fr' ? 'Veuillez s√©lectionner au moins un participant' : 'Please select at least one participant');
                return;
            }

            const genderPreference = document.querySelector('input[name="genderPref"]:checked')?.value || 'mixed';

            try {
                const response = await fetch('/api/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId, members, genderPreference })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
                alert(currentLang === 'fr' 
                    ? `Inscription r√©ussie !\n\n‚ö†Ô∏è NOTEZ BIEN CE CODE : ${result.code}\n\nVous en aurez besoin pour modifier votre chambre.`
                    : `Registration successful!\n\n‚ö†Ô∏è NOTE THIS CODE: ${result.code}\n\nYou will need it to modify your room.`);
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        // Modification
        async function initiateModification(roomId) {
            roomToModify = roomId;
            showModal('modificationModal');
        }

        async function confirmModification() {
            const code = document.getElementById('modificationCodeInput').value;
            
            if (!confirm(currentLang === 'fr'
                ? '‚ö†Ô∏è Supprimer l\'ensemble du groupe de cette chambre et se r√©inscrire dans une autre ?'
                : '‚ö†Ô∏è Delete the entire group from this room and re-register in another?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/modify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: roomToModify, code })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                hideModal('modificationModal');
                
                const container = document.getElementById('memberInputs');
                container.innerHTML = result.groupMembers.map((m, i) => `
                    <div class="member-row">
                        <select class="member-select" onchange="updateMemberSelects()">
                            <option value="">-- ${t('chooseParticipant')} --</option>
                            ${getAvailableParticipants().map(p => `
                                <option value="${p}" ${p === m ? 'selected' : ''}>${p}</option>
                            `).join('')}
                        </select>
                        ${i > 0 ? '<button class="btn btn-danger" onclick="removeMemberRow(this)">üóëÔ∏è</button>' : ''}
                    </div>
                `).join('');

                renderApp();
                alert(currentLang === 'fr'
                    ? `Groupe retir√© de la chambre n¬∞${roomToModify}.\nVous pouvez maintenant choisir une nouvelle chambre.`
                    : `Group removed from room #${roomToModify}.\nYou can now choose a new room.`);
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        // Admin functions
        async function toggleAdminMode() {
            if (isAdmin) {
                isAdmin = false;
                renderApp();
            } else {
                showModal('adminLoginModal');
            }
        }

        function loginAdmin() {
            const password = document.getElementById('adminPasswordInput').value;
            if (password === 'adminlvp25') {
                isAdmin = true;
                hideModal('adminLoginModal');
                renderApp();
            } else {
                alert(currentLang === 'fr' ? 'Code incorrect !' : 'Incorrect code!');
            }
        }

        async function removeOccupant(roomId, occupant) {
            if (!confirm(currentLang === 'fr' ? `Retirer ${occupant} de cette chambre ?` : `Remove ${occupant} from this room?`)) return;

            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId, occupant, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        async function toggleFemaleOnly(roomId) {
            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/toggle-female', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                const participants = lines.slice(1).map(line => {
                    const cols = line.split(/[,;\t]/);
                    return cols[0]?.trim();
                }).filter(name => name && name.length > 0);
                
                // Check capacity
                if (participants.length > appData.totalCapacity) {
                    alert(currentLang === 'fr'
                        ? `‚ö†Ô∏è ATTENTION : Vous importez ${participants.length} participants mais la capacit√© totale est de ${appData.totalCapacity} lits.\n\nIl manque ${participants.length - appData.totalCapacity} places !`
                        : `‚ö†Ô∏è WARNING: You are importing ${participants.length} participants but the total capacity is ${appData.totalCapacity} beds.\n\n${participants.length - appData.totalCapacity} places are missing!`);
                }

                const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
                
                try {
                    const response = await fetch('/api/admin/upload-participants', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ participants, password })
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        alert(result.error);
                        return;
                    }

                    appData = result.data;
                    renderApp();
                    alert(currentLang === 'fr' 
                        ? `${participants.length} participants import√©s !` 
                        : `${participants.length} participants imported!`);
                } catch (error) {
                    alert('Erreur : ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function exportResults() {
            let csv = 'Chambre,Type,Capacit√©,Occupants,Femmes Seulement,Pr√©f√©rence\n';
            appData.rooms.forEach(room => {
                csv += `${room.id},${room.type},${room.capacity},"${room.occupants.join('; ')}",${room.isFemaleOnly ? 'Oui' : 'Non'},${room.genderPreference}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'attributions_chambres.csv';
            a.click();
        }

        // UI helpers
        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function addMemberInput() {
            const container = document.getElementById('memberInputs');
            const div = document.createElement('div');
            div.className = 'member-row';
            div.innerHTML = `
                <select class="member-select" onchange="updateMemberSelects()">
                    <option value="">-- ${t('chooseParticipant')} --</option>
                    ${getAvailableParticipants().map(p => `
                        <option value="${p}">${p}</option>
                    `).join('')}
                </select>
                <button class="btn btn-danger" onclick="removeMemberRow(this)">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        }

        function removeMemberRow(btn) {
            btn.parentElement.remove();
            updateMemberSelects();
        }

        function getAvailableParticipants() {
            const assignedParticipants = new Set();
            appData.rooms.forEach(room => {
                room.occupants.forEach(occupant => assignedParticipants.add(occupant));
            });
            return appData.participants.filter(p => !assignedParticipants.has(p));
        }

        function updateMemberSelects() {
            const selects = document.querySelectorAll('.member-select');
            const available = getAvailableParticipants();
            
            selects.forEach(select => {
                const currentValue = select.value;
                const selectedValues = Array.from(selects)
                    .map(s => s.value)
                    .filter(v => v && v !== currentValue);

                select.innerHTML = `
                    <option value="">-- ${t('chooseParticipant')} --</option>
                    ${available.filter(p => !selectedValues.includes(p)).map(p => `
                        <option value="${p}" ${p === currentValue ? 'selected' : ''}>${p}</option>
                    `).join('')}
                `;
            });
        }

        // Admin participant management
        function addParticipant() {
            const name = prompt(currentLang === 'fr' ? 'Nom du nouveau participant :' : 'New participant name:');
            if (!name || !name.trim()) return;

            if (appData.participants.includes(name.trim())) {
                alert(currentLang === 'fr' ? 'Ce participant existe d√©j√† !' : 'This participant already exists!');
                return;
            }

            appData.participants.push(name.trim());
            appData.participants.sort();
            saveParticipants();
        }

        function editParticipant(oldName, index) {
            const newName = prompt(currentLang === 'fr' ? 'Modifier le nom :' : 'Edit name:', oldName);
            if (!newName || !newName.trim() || newName === oldName) return;

            if (appData.participants.includes(newName.trim())) {
                alert(currentLang === 'fr' ? 'Ce nom existe d√©j√† !' : 'This name already exists!');
                return;
            }

            const isAssigned = appData.rooms.some(r => r.occupants.includes(oldName));
            if (isAssigned) {
                if (!confirm(currentLang === 'fr'
                    ? `‚ö†Ô∏è ${oldName} est d√©j√† inscrit dans une chambre.\nLe modifier mettra √† jour son inscription. Continuer ?`
                    : `‚ö†Ô∏è ${oldName} is already registered in a room.\nModifying will update their registration. Continue?`)) {
                    return;
                }
                appData.rooms.forEach(room => {
                    const idx = room.occupants.indexOf(oldName);
                    if (idx !== -1) {
                        room.occupants[idx] = newName.trim();
                    }
                });
                if (appData.registrationCodes[oldName]) {
                    appData.registrationCodes[newName.trim()] = appData.registrationCodes[oldName];
                    delete appData.registrationCodes[oldName];
                }
            }

            appData.participants[index] = newName.trim();
            appData.participants.sort();
            saveParticipants();
        }

        function deleteParticipant(name, index) {
            const isAssigned = appData.rooms.some(r => r.occupants.includes(name));
            if (isAssigned) {
                alert(currentLang === 'fr'
                    ? `‚ùå Impossible de supprimer ${name} car il/elle est d√©j√† inscrit(e) dans une chambre.\nRetirez-le d'abord de sa chambre.`
                    : `‚ùå Cannot delete ${name} because they are already registered in a room.\nRemove them from their room first.`);
                return;
            }

            if (!confirm(currentLang === 'fr' ? `Supprimer ${name} de la liste ?` : `Delete ${name} from the list?`)) return;

            appData.participants.splice(index, 1);
            saveParticipants();
        }

        async function clearAllParticipants() {
            if (!confirm(currentLang === 'fr'
                ? '‚ö†Ô∏è ATTENTION : √ätes-vous s√ªr de vouloir effacer toute la liste des participants ?\n\nCette action est irr√©versible !'
                : '‚ö†Ô∏è WARNING: Are you sure you want to clear the entire participants list?\n\nThis action is irreversible!')) {
                return;
            }

            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/clear-participants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
                alert(currentLang === 'fr' ? 'Liste effac√©e !' : 'List cleared!');
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        async function saveParticipants() {
            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/update-participants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ participants: appData.participants, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    loadData();
                    return;
                }

                appData = result.data;
                alert(currentLang === 'fr' ? '‚úÖ Liste des participants sauvegard√©e !' : '‚úÖ Participants list saved!');
                renderApp();
            } catch (error) {
                alert('Erreur : ' + error.message);
                loadData();
            }
        }

        // Room configuration
        function showRoomConfig() {
            showModal('roomConfigModal');
        }

        function saveRoomConfig() {
            const inputs = document.querySelectorAll('.room-config-row');
            const rooms = [];
            const roomIds = new Set();

            for (let input of inputs) {
                const id = input.querySelector('.room-id').value.trim();
                const capacity = parseInt(input.querySelector('.room-capacity').value);
                const type = input.querySelector('.room-type').value;

                if (!id) {
                    alert(currentLang === 'fr' ? 'Tous les num√©ros de chambre doivent √™tre renseign√©s' : 'All room numbers must be filled');
                    return;
                }

                if (roomIds.has(id)) {
                    alert(currentLang === 'fr' ? `Le num√©ro de chambre "${id}" est utilis√© plusieurs fois !` : `Room number "${id}" is used multiple times!`);
                    return;
                }

                roomIds.add(id);

                if (!capacity || capacity < 1) {
                    alert(currentLang === 'fr' ? 'Toutes les capacit√©s doivent √™tre sup√©rieures √† 0' : 'All capacities must be greater than 0');
                    return;
                }

                rooms.push({ id, capacity, type: type || `${capacity} lits` });
            }

            if (rooms.length === 0) {
                alert(currentLang === 'fr' ? 'Au moins une chambre est n√©cessaire' : 'At least one room is required');
                return;
            }

            if (!confirm(currentLang === 'fr'
                ? `‚ö†Ô∏è Vous allez remplacer la configuration des chambres.\n\n${rooms.length} chambres, capacit√© totale: ${rooms.reduce((sum, r) => sum + r.capacity, 0)} lits.\n\nContinuer ?`
                : `‚ö†Ô∏è You will replace the room configuration.\n\n${rooms.length} rooms, total capacity: ${rooms.reduce((sum, r) => sum + r.capacity, 0)} beds.\n\nContinue?`)) {
                return;
            }

            updateRoomsInDB(rooms);
        }

        async function updateRoomsInDB(rooms) {
            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/update-rooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rooms, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                hideModal('roomConfigModal');
                renderApp();
                alert(currentLang === 'fr' ? '‚úÖ Configuration des chambres mise √† jour !' : '‚úÖ Room configuration updated!');
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        function generateRoomConfigHTML() {
            const grouped = {};
            appData.rooms.forEach(room => {
                const key = `${room.capacity} lits`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(room.id);
            });

            let html = '<div style="margin-bottom: 20px;">';
            html += '<h3 style="margin-bottom: 10px;">' + (currentLang === 'fr' ? 'Configuration actuelle :' : 'Current configuration:') + '</h3>';
            html += '<table><thead><tr><th>' + (currentLang === 'fr' ? 'Type' : 'Type') + '</th><th>' + (currentLang === 'fr' ? 'Nombre' : 'Count') + '</th><th>' + (currentLang === 'fr' ? 'Num√©ros' : 'Numbers') + '</th></tr></thead><tbody>';
            
            Object.entries(grouped).forEach(([type, ids]) => {
                html += `<tr><td>${type}</td><td>${ids.length}</td><td>${ids.join(', ')}</td></tr>`;
            });
            
            html += '</tbody></table></div>';

            html += '<div style="margin-bottom: 20px;"><h3>' + (currentLang === 'fr' ? 'Modifier la configuration :' : 'Edit configuration:') + '</h3>';
            html += '<div id="roomConfigList">';
            
            appData.rooms.forEach(room => {
                html += `
                    <div class="room-config-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <input type="text" class="room-id" value="${room.id}" placeholder="${currentLang === 'fr' ? 'N¬∞ chambre' : 'Room #'}" style="width: 100px;">
                        <input type="number" class="room-capacity" value="${room.capacity}" min="1" placeholder="${currentLang === 'fr' ? 'Capacit√©' : 'Capacity'}" style="width: 100px;">
                        <input type="text" class="room-type" value="${room.type}" placeholder="${currentLang === 'fr' ? 'Type (optionnel)' : 'Type (optional)'}" style="flex: 1;">
                        <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<button class="btn btn-primary" onclick="addRoomConfigRow()">' + (currentLang === 'fr' ? '‚ûï Ajouter une chambre' : '‚ûï Add a room') + '</button>';
            html += '</div>';

            return html;
        }

        function addRoomConfigRow() {
            const container = document.getElementById('roomConfigList');
            const div = document.createElement('div');
            div.className = 'room-config-row';
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            div.innerHTML = `
                <input type="text" class="room-id" placeholder="${currentLang === 'fr' ? 'N¬∞ chambre' : 'Room #'}" style="width: 100px;">
                <input type="number" class="room-capacity" value="2" min="1" placeholder="${currentLang === 'fr' ? 'Capacit√©' : 'Capacity'}" style="width: 100px;">
                <input type="text" class="room-type" placeholder="${currentLang === 'fr' ? 'Type (optionnel)' : 'Type (optional)'}" style="flex: 1;">
                <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        }

        // Render
        function renderApp() {
            const totalOccupied = appData.rooms.reduce((sum, r) => sum + r.occupants.length, 0);
            const availableRooms = appData.rooms.filter(r => r.occupants.length < r.capacity);
            
            const roomOrder = ['2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','25','26','C','E','G','I'];
            const sortedRooms = [...appData.rooms].sort((a, b) => {
                const aIndex = roomOrder.indexOf(a.id);
                const bIndex = roomOrder.indexOf(b.id);
                if (aIndex === -1 && bIndex === -1) return a.id.localeCompare(b.id);
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });
            
            const grouped = {};
            sortedRooms.forEach(room => {
                if (!grouped[room.type]) grouped[room.type] = [];
                grouped[room.type].push(room);
            });

            const typeOrder = ['2 lits', '6 lits', '5 lits', '3 lits'];

            const capacityWarning = appData.participants.length > appData.totalCapacity 
                ? `<div class="alert alert-warning">
                    ‚ö†Ô∏è ${currentLang === 'fr' 
                        ? `ATTENTION : ${appData.participants.length} participants pour ${appData.totalCapacity} lits. Il manque ${appData.participants.length - appData.totalCapacity} places !`
                        : `WARNING: ${appData.participants.length} participants for ${appData.totalCapacity} beds. ${appData.participants.length - appData.totalCapacity} places are missing!`}
                </div>`
                : '';

            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div class="header-content">
                        <div>
                            <h1>üë• ${t('title')}</h1>
                            <p class="stats">${totalOccupied} / ${appData.totalCapacity} ${t('participantsRegistered')}</p>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div class="language-switcher">
                                <span class="flag-btn ${currentLang === 'fr' ? 'active' : ''}" data-lang="fr" onclick="switchLanguage('fr')" title="Fran√ßais">üá´üá∑</span>
                                <span class="flag-btn ${currentLang === 'en' ? 'active' : ''}" data-lang="en" onclick="switchLanguage('en')" title="English">üá¨üáß</span>
                            </div>
                            <button class="btn btn-primary" onclick="toggleAdminMode()">
                                üîê ${isAdmin ? t('quitAdmin') : t('adminMode')}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="admin-panel ${isAdmin ? 'active' : ''}">
                    <h2 style="margin-bottom: 15px;">${t('administration')}</h2>
                    
                    ${capacityWarning}

                    <div class="admin-section">
                        <h3 style="margin-bottom: 15px;">${t('roomManagement')}</h3>
                        <button class="btn btn-primary" onclick="showRoomConfig()">
                            ‚öôÔ∏è ${t('editRooms')}
                        </button>
                        <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                            ${currentLang === 'fr' 
                                ? `Configuration actuelle : ${appData.rooms.length} chambres, ${appData.totalCapacity} lits au total`
                                : `Current configuration: ${appData.rooms.length} rooms, ${appData.totalCapacity} beds total`}
                        </p>
                    </div>

                    <div class="admin-section">
                        <h3 style="margin-bottom: 15px;">${t('participantsList')}</h3>
                        <div class="admin-controls">
                            <label class="btn btn-primary" style="cursor: pointer;">
                                üì§ ${t('importCSV')}
                                <input type="file" accept=".csv,.xlsx,.xls,.txt" onchange="handleFileUpload(event)" style="display: none;">
                            </label>
                            <button class="btn btn-success" onclick="exportResults()">
                                üì• ${t('exportResults')}
                            </button>
                            <button class="btn btn-danger" onclick="clearAllParticipants()">
                                üóëÔ∏è ${t('clearAll')}
                            </button>
                            <div style="padding: 12px 24px; background: white; border-radius: 8px; font-weight: 600;">
                                ${appData.participants.length} ${t('participantsLoaded')}
                            </div>
                            <div style="padding: 12px 24px; background: #dcfce7; border-radius: 8px; font-weight: 600; color: #166534;">
                                ${t('totalCapacity')}: ${appData.totalCapacity} ${t('beds')}
                            </div>
                        </div>

                        <div class="participant-list">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0;">${appData.participants.length} ${t('participantsLoaded')}</h4>
                                <button class="btn btn-primary btn-small" onclick="addParticipant()">
                                    ‚ûï ${t('add')}
                                </button>
                            </div>
                            ${appData.participants.length === 0 ? `
                                <p style="text-align: center; color: #666; padding: 20px;">
                                    ${t('noParticipants')}
                                </p>
                            ` : `
                                ${appData.participants.map((p, index) => {
                                    const isAssigned = appData.rooms.some(r => r.occupants.includes(p));
                                    return `
                                        <div class="participant-item">
                                            <span style="${isAssigned ? 'color: #10b981; font-weight: 600;' : ''}">
                                                ${p} ${isAssigned ? '‚úì ' + t('registered') : ''}
                                            </span>
                                            <div class="participant-actions">
                                                <button class="btn btn-primary btn-small" onclick="editParticipant('${p.replace(/'/g, "\\'")}', ${index})">
                                                    ‚úèÔ∏è ${t('modify')}
                                                </button>
                                                <button class="btn btn-danger btn-small" onclick="deleteParticipant('${p.replace(/'/g, "\\'")}', ${index})">
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            `}
                        </div>
                    </div>
                </div>

                ${!isAdmin ? `
                <div class="inscription-form">
                    <h2 style="margin-bottom: 20px;">${t('inscription')}</h2>
                    
                    <div class="form-group">
                        <label>${t('selectRoom')}</label>
                        <select id="roomSelect">
                            <option value="">${t('chooseRoom')}</option>
                            ${availableRooms.sort((a, b) => {
                                const aIndex = roomOrder.indexOf(a.id);
                                const bIndex = roomOrder.indexOf(b.id);
                                if (aIndex === -1 && bIndex === -1) return a.id.localeCompare(b.id);
                                if (aIndex === -1) return 1;
                                if (bIndex === -1) return -1;
                                return aIndex - bIndex;
                            }).map(room => {
                                let prefLabel = '';
                                if (room.genderPreference === 'female_only') prefLabel = ' üö∫';
                                else if (room.genderPreference === 'male_only') prefLabel = ' üöπ';
                                
                                return `
                                <option value="${room.id}">
                                    ${t('room')}${room.id} (${room.type}) - ${room.capacity - room.occupants.length} ${t('placesRemaining')}${prefLabel}
                                </option>
                            `}).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>${t('groupMembers')}</label>
                        <div class="member-inputs" id="memberInputs">
                            <div class="member-row">
                                <select class="member-select" onchange="updateMemberSelects()">
                                    <option value="">${t('chooseParticipant')}</option>
                                    ${getAvailableParticipants().map(p => `
                                        <option value="${p}">${p}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addMemberInput(); updateMemberSelects();" style="margin-top: 10px;">
                            ‚ûï ${t('addMember')}
                        </button>
                    </div>

                    <div class="form-group">
                        <label>${t('roomPreference')}</label>
                        <div class="gender-preference">
                            <div class="gender-option">
                                <input type="radio" name="genderPref" value="mixed" id="mixed" checked>
                                <label for="mixed" style="margin: 0;">${t('mixed')}</label>
                            </div>
                            <div class="gender-option">
                                <input type="radio" name="genderPref" value="female_only" id="femaleOnly">
                                <label for="femaleOnly" style="margin: 0;">üö∫ ${t('femalesOnly')}</label>
                            </div>
                            <div class="gender-option">
                                <input type="radio" name="genderPref" value="male_only" id="maleOnly">
                                <label for="maleOnly" style="margin: 0;">üöπ ${t('malesOnly')}</label>
                            </div>
                        </div>
                        <div class="info-box">
                            ‚ÑπÔ∏è ${t('preferenceInfo')}
                        </div>
                    </div>

                    <button class="btn btn-success btn-block" onclick="assignGroup()">
                        ${t('confirmInscription')}
                    </button>
                </div>
                ` : ''}

                ${typeOrder.map(type => {
                    if (!grouped[type]) return '';
                    const rooms = grouped[type];
                    return `
                    <div class="rooms-grid">
                        <h2 class="room-type-title">${t('rooms')} ${type} (${rooms.length} ${t('roomsCount')})</h2>
                        <div class="rooms-container">
                            ${rooms.map(room => {
                                let cardClass = 'room-card ';
                                if (room.occupants.length === room.capacity) cardClass += 'full';
                                else if (room.genderPreference === 'female_only') cardClass += 'female-pref';
                                else if (room.genderPreference === 'male_only') cardClass += 'male-pref';
                                else cardClass += 'available';

                                let genderBadge = '';
                                if (room.genderPreference === 'female_only') {
                                    genderBadge = `<span class="badge badge-female">üö∫ ${currentLang === 'fr' ? 'FEMMES' : 'FEMALES'}</span>`;
                                } else if (room.genderPreference === 'male_only') {
                                    genderBadge = `<span class="badge badge-male">üöπ ${currentLang === 'fr' ? 'HOMMES' : 'MALES'}</span>`;
                                }

                                return `
                                <div class="${cardClass}">
                                    <div class="room-header">
                                        <div>
                                            <div class="room-title">${t('room')}${room.id}</div>
                                            <div style="font-size: 0.9rem; color: #666;">${room.occupants.length} / ${room.capacity} ${t('people')}</div>
                                        </div>
                                        <div style="display: flex; gap: 5px; flex-direction: column;">
                                            ${genderBadge}
                                            ${isAdmin && room.isFemaleOnly ? `
                                                <button class="badge badge-female" onclick="toggleFemaleOnly('${room.id}')">
                                                    üö∫ ${currentLang === 'fr' ? 'FEMMES' : 'FEMALES'}
                                                </button>
                                            ` : ''}
                                            ${!isAdmin && room.occupants.length > 0 ? `
                                                <button class="btn btn-warning" onclick="initiateModification('${room.id}')">
                                                    üóëÔ∏è ${t('deleteMyGroup')}
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="occupants-list">
                                        ${room.occupants.map(occupant => `
                                            <div class="occupant-item">
                                                <span>${occupant}</span>
                                                ${isAdmin ? `
                                                    <button onclick="removeOccupant('${room.id}', '${occupant}')" style="background: none; border: none; color: #ef4444; cursor: pointer;">
                                                        üóëÔ∏è
                                                    </button>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                        ${Array(room.capacity - room.occupants.length).fill(null).map(() => `
                                            <div class="empty-bed">${t('availableBed')}</div>
                                        `).join('')}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    `;
                }).join('')}

                <!-- Modals -->
                <div class="modal" id="adminLoginModal">
                    <div class="modal-content">
                        <h2 style="margin-bottom: 20px;">${t('adminLogin')}</h2>
                        <input type="password" id="adminPasswordInput" placeholder="${t('adminCode')}" style="margin-bottom: 20px;" onkeypress="if(event.key==='Enter') loginAdmin()">
                        <div class="modal-buttons">
                            <button class="btn btn-primary" style="flex: 1;" onclick="loginAdmin()">${t('login')}</button>
                            <button class="btn btn-danger" style="flex: 1;" onclick="hideModal('adminLoginModal')">${t('cancel')}</button>
                        </div>
                    </div>
                </div>

                <div class="modal" id="modificationModal">
                    <div class="modal-content">
                        <h2 style="margin-bottom: 20px;">${t('modifyInscription')}</h2>
                        <p style="color: #666; margin-bottom: 20px;">${t('enterCode')}</p>
                        <input type="text" id="modificationCodeInput" placeholder="${t('codeExample')}" maxlength="6" style="text-transform: uppercase; margin-bottom: 20px;" onkeypress="if(event.key==='Enter') confirmModification()">
                        <div class="modal-buttons">
                            <button class="btn btn-primary" style="flex: 1;" onclick="confirmModification()">${t('confirm')}</button>
                            <button class="btn btn-danger" style="flex: 1;" onclick="hideModal('modificationModal')">${t('cancel')}</button>
                        </div>
                    </div>
                </div>

                <div class="modal" id="roomConfigModal">
                    <div class="modal-content">
                        <h2 style="margin-bottom: 20px;">${t('roomManagement')}</h2>
                        <div id="roomConfigContent">${generateRoomConfigHTML()}</div>
                        <div class="modal-buttons">
                            <button class="btn btn-success" style="flex: 1;" onclick="saveRoomConfig()">${currentLang === 'fr' ? 'Sauvegarder' : 'Save'}</button>
                            <button class="btn btn-danger" style="flex: 1;" onclick="hideModal('roomConfigModal')">${t('cancel')}</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
