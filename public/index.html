<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attribution de chambres / Room Assignment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .language-switcher {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .lang-btn {
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #666;
            transition: all 0.3s;
        }

        .lang-btn:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .lang-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        h1 {
            font-size: 2rem;
            color: #333;
        }

        .stats {
            font-size: 1.1rem;
            color: #666;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            font-size: 0.75rem;
            padding: 6px 12px;
        }

        .admin-panel {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .admin-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .participant-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .participant-item:last-child {
            border-bottom: none;
        }

        .participant-item input {
            flex: 1;
            margin-right: 10px;
        }

        .participant-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .inscription-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .member-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .member-row {
            display: flex;
            gap: 10px;
        }

        .member-row select {
            flex: 1;
        }

        .gender-preference {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .gender-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .info-box {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.9rem;
            color: #92400e;
            margin-top: 10px;
        }

        .rooms-grid {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .room-type-section {
            margin-bottom: 40px;
        }

        .room-type-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .rooms-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .room-card {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .room-card.available {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .room-card.full {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .room-card.female-pref {
            background: #fce7f3;
            border-color: #f9a8d4;
        }

        .room-card.male-pref {
            background: #dbeafe;
            border-color: #93c5fd;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .room-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .badge-female {
            background: #fce7f3;
            color: #be185d;
        }

        .badge-mixed {
            background: #e5e7eb;
            color: #6b7280;
        }

        .badge-male {
            background: #dbeafe;
            color: #1e40af;
        }

        .occupants-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .occupant-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .empty-bed {
            background: white;
            padding: 10px;
            border-radius: 6px;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-block {
            width: 100%;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5rem;
            color: white;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            color: #065f46;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table th, table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        table th {
            background: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="loading">‚è≥ <span class="loading-text">Chargement...</span></div>
    </div>

    <script>
        let appData = { rooms: [], participants: [], registrationCodes: {}, totalCapacity: 0 };
        let isAdmin = false;
        let roomToModify = null;
        let currentLang = 'fr';

        const translations = {
            fr: {
                title: 'Attribution de chambres',
                adminMode: 'Mode Admin',
                quitAdmin: 'Quitter Admin',
                participantsRegistered: 'participants inscrits',
                loading: 'Chargement...',
                administration: 'Administration',
                importCSV: 'Importer Excel/CSV',
                exportResults: 'Exporter les r√©sultats',
                participantsLoaded: 'participants charg√©s',
                totalCapacity: 'Capacit√© totale',
                beds: 'lits',
                participantsList: 'Liste des participants',
                add: 'Ajouter',
                noParticipants: 'Aucun participant. Importez un fichier CSV ou ajoutez-les manuellement.',
                registered: 'Inscrit',
                modify: 'Modifier',
                delete: 'Supprimer',
                clearAll: 'Effacer toute la liste',
                roomManagement: 'Gestion des chambres',
                editRooms: 'Modifier les chambres',
                inscription: 'Inscription',
                selectRoom: 'S√©lectionnez une chambre disponible',
                chooseRoom: '-- Choisir une chambre --',
                room: 'Chambre n¬∞',
                placesRemaining: 'places restantes',
                groupMembers: 'Membres du groupe',
                chooseParticipant: '-- Choisir un participant --',
                addMember: 'Ajouter un membre',
                roomPreference: 'Pr√©f√©rence de chambre (premi√®re r√©servation uniquement)',
                mixed: 'Mixte',
                femalesOnly: 'Femmes uniquement',
                malesOnly: 'Hommes uniquement',
                preferenceInfo: 'Note : Cette pr√©f√©rence peut ne pas √™tre respect√©e selon le nombre d\'hommes et de femmes du voyage et la capacit√© des chambres.',
                confirmInscription: 'Confirmer l\'inscription',
                rooms: 'Chambres',
                roomsCount: 'chambres',
                people: 'personnes',
                deleteMyGroup: 'Supprimer mon groupe',
                availableBed: 'Lit disponible',
                adminLogin: 'Connexion Admin',
                adminCode: 'Code admin',
                login: 'Connexion',
                cancel: 'Annuler',
                modifyInscription: 'Modifier votre inscription',
                enterCode: 'Entrez le code re√ßu lors de votre inscription.',
                codeExample: 'CODE (ex: AB12CD)',
                confirm: 'Confirmer'
            },
            en: {
                title: 'Room Assignment',
                adminMode: 'Admin Mode',
                quitAdmin: 'Quit Admin',
                participantsRegistered: 'participants registered',
                loading: 'Loading...',
                administration: 'Administration',
                importCSV: 'Import Excel/CSV',
                exportResults: 'Export results',
                participantsLoaded: 'participants loaded',
                totalCapacity: 'Total capacity',
                beds: 'beds',
                participantsList: 'Participants list',
                add: 'Add',
                noParticipants: 'No participants. Import a CSV file or add them manually.',
                registered: 'Registered',
                modify: 'Edit',
                delete: 'Delete',
                clearAll: 'Clear entire list',
                roomManagement: 'Room Management',
                editRooms: 'Edit rooms',
                inscription: 'Registration',
                selectRoom: 'Select an available room',
                chooseRoom: '-- Choose a room --',
                room: 'Room #',
                placesRemaining: 'places remaining',
                groupMembers: 'Group members',
                chooseParticipant: '-- Choose a participant --',
                addMember: 'Add member',
                roomPreference: 'Room preference (first reservation only)',
                mixed: 'Mixed',
                femalesOnly: 'Females only',
                malesOnly: 'Males only',
                preferenceInfo: 'Note: This preference may not be respected depending on the number of men and women in the trip and room capacity.',
                confirmInscription: 'Confirm registration',
                rooms: 'Rooms',
                roomsCount: 'rooms',
                people: 'people',
                deleteMyGroup: 'Delete my group',
                availableBed: 'Available bed',
                adminLogin: 'Admin Login',
                adminCode: 'Admin code',
                login: 'Login',
                cancel: 'Cancel',
                modifyInscription: 'Modify your registration',
                enterCode: 'Enter the code received during your registration.',
                codeExample: 'CODE (e.g.: AB12CD)',
                confirm: 'Confirm'
            }
        };

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function switchLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-lang="${lang}"]`).classList.add('active');
            renderApp();
        }

        // Load data
        async function loadData() {
            try {
                const response = await fetch('/api/data');
                appData = await response.json();
                renderApp();
            } catch (error) {
                alert('Erreur de chargement : ' + error.message);
            }
        }

        // Assign group
        async function assignGroup() {
            const roomId = document.getElementById('roomSelect').value;
            if (!roomId) {
                alert(currentLang === 'fr' ? 'Veuillez s√©lectionner une chambre' : 'Please select a room');
                return;
            }

            const selects = document.querySelectorAll('.member-select');
            const members = Array.from(selects).map(s => s.value).filter(m => m);

            if (members.length === 0) {
                alert(currentLang === 'fr' ? 'Veuillez s√©lectionner au moins un participant' : 'Please select at least one participant');
                return;
            }

            const genderPreference = document.querySelector('input[name="genderPref"]:checked')?.value || 'mixed';

            try {
                const response = await fetch('/api/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId, members, genderPreference })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
                alert(currentLang === 'fr' 
                    ? `Inscription r√©ussie !\n\n‚ö†Ô∏è NOTEZ BIEN CE CODE : ${result.code}\n\nVous en aurez besoin pour modifier votre chambre.`
                    : `Registration successful!\n\n‚ö†Ô∏è NOTE THIS CODE: ${result.code}\n\nYou will need it to modify your room.`);
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        // Modification
        async function initiateModification(roomId) {
            roomToModify = roomId;
            showModal('modificationModal');
        }

        async function confirmModification() {
            const code = document.getElementById('modificationCodeInput').value;
            
            if (!confirm(currentLang === 'fr'
                ? '‚ö†Ô∏è Supprimer l\'ensemble du groupe de cette chambre et se r√©inscrire dans une autre ?'
                : '‚ö†Ô∏è Delete the entire group from this room and re-register in another?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/modify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: roomToModify, code })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                hideModal('modificationModal');
                
                const container = document.getElementById('memberInputs');
                container.innerHTML = result.groupMembers.map((m, i) => `
                    <div class="member-row">
                        <select class="member-select" onchange="updateMemberSelects()">
                            <option value="">-- ${t('chooseParticipant')} --</option>
                            ${getAvailableParticipants().map(p => `
                                <option value="${p}" ${p === m ? 'selected' : ''}>${p}</option>
                            `).join('')}
                        </select>
                        ${i > 0 ? '<button class="btn btn-danger" onclick="removeMemberRow(this)">üóëÔ∏è</button>' : ''}
                    </div>
                `).join('');

                renderApp();
                alert(currentLang === 'fr'
                    ? `Groupe retir√© de la chambre n¬∞${roomToModify}.\nVous pouvez maintenant choisir une nouvelle chambre.`
                    : `Group removed from room #${roomToModify}.\nYou can now choose a new room.`);
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        // Admin functions
        async function toggleAdminMode() {
            if (isAdmin) {
                isAdmin = false;
                renderApp();
            } else {
                showModal('adminLoginModal');
            }
        }

        function loginAdmin() {
            const password = document.getElementById('adminPasswordInput').value;
            if (password === 'adminlvp25') {
                isAdmin = true;
                hideModal('adminLoginModal');
                renderApp();
            } else {
                alert(currentLang === 'fr' ? 'Code incorrect !' : 'Incorrect code!');
            }
        }

        async function removeOccupant(roomId, occupant) {
            if (!confirm(currentLang === 'fr' ? `Retirer ${occupant} de cette chambre ?` : `Remove ${occupant} from this room?`)) return;

            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId, occupant, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        async function toggleFemaleOnly(roomId) {
            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/toggle-female', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                const participants = lines.slice(1).map(line => {
                    const cols = line.split(/[,;\t]/);
                    return cols[0]?.trim();
                }).filter(name => name && name.length > 0);
                
                // Check capacity
                if (participants.length > appData.totalCapacity) {
                    alert(currentLang === 'fr'
                        ? `‚ö†Ô∏è ATTENTION : Vous importez ${participants.length} participants mais la capacit√© totale est de ${appData.totalCapacity} lits.\n\nIl manque ${participants.length - appData.totalCapacity} places !`
                        : `‚ö†Ô∏è WARNING: You are importing ${participants.length} participants but the total capacity is ${appData.totalCapacity} beds.\n\n${participants.length - appData.totalCapacity} places are missing!`);
                }

                const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
                
                try {
                    const response = await fetch('/api/admin/upload-participants', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ participants, password })
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        alert(result.error);
                        return;
                    }

                    appData = result.data;
                    renderApp();
                    alert(currentLang === 'fr' 
                        ? `${participants.length} participants import√©s !` 
                        : `${participants.length} participants imported!`);
                } catch (error) {
                    alert('Erreur : ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function exportResults() {
            let csv = 'Chambre,Type,Capacit√©,Occupants,Femmes Seulement,Pr√©f√©rence\n';
            appData.rooms.forEach(room => {
                csv += `${room.id},${room.type},${room.capacity},"${room.occupants.join('; ')}",${room.isFemaleOnly ? 'Oui' : 'Non'},${room.genderPreference}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'attributions_chambres.csv';
            a.click();
        }

        // UI helpers
        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function addMemberInput() {
            const container = document.getElementById('memberInputs');
            const div = document.createElement('div');
            div.className = 'member-row';
            div.innerHTML = `
                <select class="member-select" onchange="updateMemberSelects()">
                    <option value="">-- ${t('chooseParticipant')} --</option>
                    ${getAvailableParticipants().map(p => `
                        <option value="${p}">${p}</option>
                    `).join('')}
                </select>
                <button class="btn btn-danger" onclick="removeMemberRow(this)">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        }

        function removeMemberRow(btn) {
            btn.parentElement.remove();
            updateMemberSelects();
        }

        function getAvailableParticipants() {
            const assignedParticipants = new Set();
            appData.rooms.forEach(room => {
                room.occupants.forEach(occupant => assignedParticipants.add(occupant));
            });
            return appData.participants.filter(p => !assignedParticipants.has(p));
        }

        function updateMemberSelects() {
            const selects = document.querySelectorAll('.member-select');
            const available = getAvailableParticipants();
            
            selects.forEach(select => {
                const currentValue = select.value;
                const selectedValues = Array.from(selects)
                    .map(s => s.value)
                    .filter(v => v && v !== currentValue);

                select.innerHTML = `
                    <option value="">-- ${t('chooseParticipant')} --</option>
                    ${available.filter(p => !selectedValues.includes(p)).map(p => `
                        <option value="${p}" ${p === currentValue ? 'selected' : ''}>${p}</option>
                    `).join('')}
                `;
            });
        }

        // Admin participant management
        function addParticipant() {
            const name = prompt(currentLang === 'fr' ? 'Nom du nouveau participant :' : 'New participant name:');
            if (!name || !name.trim()) return;

            if (appData.participants.includes(name.trim())) {
                alert(currentLang === 'fr' ? 'Ce participant existe d√©j√† !' : 'This participant already exists!');
                return;
            }

            appData.participants.push(name.trim());
            appData.participants.sort();
            saveParticipants();
        }

        function editParticipant(oldName, index) {
            const newName = prompt(currentLang === 'fr' ? 'Modifier le nom :' : 'Edit name:', oldName);
            if (!newName || !newName.trim() || newName === oldName) return;

            if (appData.participants.includes(newName.trim())) {
                alert(currentLang === 'fr' ? 'Ce nom existe d√©j√† !' : 'This name already exists!');
                return;
            }

            const isAssigned = appData.rooms.some(r => r.occupants.includes(oldName));
            if (isAssigned) {
                if (!confirm(currentLang === 'fr'
                    ? `‚ö†Ô∏è ${oldName} est d√©j√† inscrit dans une chambre.\nLe modifier mettra √† jour son inscription automatiquement. Continuer ?`
                    : `‚ö†Ô∏è ${oldName} is already registered in a room.\nModifying will update their registration automatically. Continue?`)) {
                    return;
                }
            }

            editParticipantInDB(oldName, newName.trim());
        }

        async function editParticipantInDB(oldName, newName) {
            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/edit-participant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldName, newName, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    loadData();
                    return;
                }

                appData = result.data;
                alert(currentLang === 'fr' ? '‚úÖ Participant modifi√© !' : '‚úÖ Participant updated!');
                renderApp();
            } catch (error) {
                alert('Erreur : ' + error.message);
                loadData();
            }
        }

        function deleteParticipant(name, index) {
