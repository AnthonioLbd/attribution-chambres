<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attribution de chambres / Room Assignment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .language-switcher {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .lang-btn {
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #666;
            transition: all 0.3s;
        }

        .lang-btn:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .lang-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        h1 {
            font-size: 2rem;
            color: #333;
        }

        .stats {
            font-size: 1.1rem;
            color: #666;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            font-size: 0.75rem;
            padding: 6px 12px;
        }

        .admin-panel {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .admin-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .participant-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .participant-item:last-child {
            border-bottom: none;
        }

        .participant-item input {
            flex: 1;
            margin-right: 10px;
        }

        .participant-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .inscription-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .member-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .member-row {
            display: flex;
            gap: 10px;
        }

        .member-row select {
            flex: 1;
        }

        .gender-preference {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .gender-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .info-box {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.9rem;
            color: #92400e;
            margin-top: 10px;
        }

        .rooms-grid {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .room-type-section {
            margin-bottom: 40px;
        }

        .room-type-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .rooms-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .room-card {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .room-card.available {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .room-card.full {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .room-card.female-pref {
            background: #fce7f3;
            border-color: #f9a8d4;
        }

        .room-card.male-pref {
            background: #dbeafe;
            border-color: #93c5fd;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .room-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .badge-female {
            background: #fce7f3;
            color: #be185d;
        }

        .badge-mixed {
            background: #e5e7eb;
            color: #6b7280;
        }

        .badge-male {
            background: #dbeafe;
            color: #1e40af;
        }

        .occupants-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .occupant-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .empty-bed {
            background: white;
            padding: 10px;
            border-radius: 6px;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-block {
            width: 100%;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5rem;
            color: white;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            color: #065f46;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table th, table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        table th {
            background: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="loading">‚è≥ <span class="loading-text">Chargement...</span></div>
    </div>

    <script>
        let appData = { rooms: [], participants: [], registrationCodes: {}, totalCapacity: 0 };
        let isAdmin = false;
        let roomToModify = null;
        let currentLang = 'fr';

        const translations = {
            fr: {
                title: 'Attribution de chambres',
                adminMode: 'Mode Admin',
                quitAdmin: 'Quitter Admin',
                participantsRegistered: 'participants inscrits',
                loading: 'Chargement...',
                administration: 'Administration',
                importCSV: 'Importer Excel/CSV',
                exportResults: 'Exporter les r√©sultats',
                participantsLoaded: 'participants charg√©s',
                totalCapacity: 'Capacit√© totale',
                beds: 'lits',
                participantsList: 'Liste des participants',
                add: 'Ajouter',
                noParticipants: 'Aucun participant. Importez un fichier CSV ou ajoutez-les manuellement.',
                registered: 'Inscrit',
                modify: 'Modifier',
                delete: 'Supprimer',
                clearAll: 'Effacer toute la liste',
                roomManagement: 'Gestion des chambres',
                editRooms: 'Modifier les chambres',
                inscription: 'Inscription',
                selectRoom: 'S√©lectionnez une chambre disponible',
                chooseRoom: '-- Choisir une chambre --',
                room: 'Chambre n¬∞',
                placesRemaining: 'places restantes',
                groupMembers: 'Membres du groupe',
                chooseParticipant: '-- Choisir un participant --',
                addMember: 'Ajouter un membre',
                roomPreference: 'Pr√©f√©rence de chambre (premi√®re r√©servation uniquement)',
                mixed: 'Mixte',
                femalesOnly: 'Femmes uniquement',
                malesOnly: 'Hommes uniquement',
                preferenceInfo: 'Note : Cette pr√©f√©rence peut ne pas √™tre respect√©e selon le nombre d\'hommes et de femmes du voyage et la capacit√© des chambres.',
                confirmInscription: 'Confirmer l\'inscription',
                rooms: 'Chambres',
                roomsCount: 'chambres',
                people: 'personnes',
                deleteMyGroup: 'Supprimer mon groupe',
                availableBed: 'Lit disponible',
                adminLogin: 'Connexion Admin',
                adminCode: 'Code admin',
                login: 'Connexion',
                cancel: 'Annuler',
                modifyInscription: 'Modifier votre inscription',
                enterCode: 'Entrez le code re√ßu lors de votre inscription.',
                codeExample: 'CODE (ex: AB12CD)',
                confirm: 'Confirmer'
            },
            en: {
                title: 'Room Assignment',
                adminMode: 'Admin Mode',
                quitAdmin: 'Quit Admin',
                participantsRegistered: 'participants registered',
                loading: 'Loading...',
                administration: 'Administration',
                importCSV: 'Import Excel/CSV',
                exportResults: 'Export results',
                participantsLoaded: 'participants loaded',
                totalCapacity: 'Total capacity',
                beds: 'beds',
                participantsList: 'Participants list',
                add: 'Add',
                noParticipants: 'No participants. Import a CSV file or add them manually.',
                registered: 'Registered',
                modify: 'Edit',
                delete: 'Delete',
                clearAll: 'Clear entire list',
                roomManagement: 'Room Management',
                editRooms: 'Edit rooms',
                inscription: 'Registration',
                selectRoom: 'Select an available room',
                chooseRoom: '-- Choose a room --',
                room: 'Room #',
                placesRemaining: 'places remaining',
                groupMembers: 'Group members',
                chooseParticipant: '-- Choose a participant --',
                addMember: 'Add member',
                roomPreference: 'Room preference (first reservation only)',
                mixed: 'Mixed',
                femalesOnly: 'Females only',
                malesOnly: 'Males only',
                preferenceInfo: 'Note: This preference may not be respected depending on the number of men and women in the trip and room capacity.',
                confirmInscription: 'Confirm registration',
                rooms: 'Rooms',
                roomsCount: 'rooms',
                people: 'people',
                deleteMyGroup: 'Delete my group',
                availableBed: 'Available bed',
                adminLogin: 'Admin Login',
                adminCode: 'Admin code',
                login: 'Login',
                cancel: 'Cancel',
                modifyInscription: 'Modify your registration',
                enterCode: 'Enter the code received during your registration.',
                codeExample: 'CODE (e.g.: AB12CD)',
                confirm: 'Confirm'
            }
        };

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function switchLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-lang="${lang}"]`).classList.add('active');
            renderApp();
        }

        // Load data
        async function loadData() {
            try {
                const response = await fetch('/api/data');
                appData = await response.json();
                renderApp();
            } catch (error) {
                alert('Erreur de chargement : ' + error.message);
            }
        }

        // Assign group
        async function assignGroup() {
            const roomId = document.getElementById('roomSelect').value;
            if (!roomId) {
                alert(currentLang === 'fr' ? 'Veuillez s√©lectionner une chambre' : 'Please select a room');
                return;
            }

            const selects = document.querySelectorAll('.member-select');
            const members = Array.from(selects).map(s => s.value).filter(m => m);

            if (members.length === 0) {
                alert(currentLang === 'fr' ? 'Veuillez s√©lectionner au moins un participant' : 'Please select at least one participant');
                return;
            }

            const genderPreference = document.querySelector('input[name="genderPref"]:checked')?.value || 'mixed';

            try {
                const response = await fetch('/api/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId, members, genderPreference })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
                alert(currentLang === 'fr' 
                    ? `Inscription r√©ussie !\n\n‚ö†Ô∏è NOTEZ BIEN CE CODE : ${result.code}\n\nVous en aurez besoin pour modifier votre chambre.`
                    : `Registration successful!\n\n‚ö†Ô∏è NOTE THIS CODE: ${result.code}\n\nYou will need it to modify your room.`);
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        // Modification
        async function initiateModification(roomId) {
            roomToModify = roomId;
            showModal('modificationModal');
        }

        async function confirmModification() {
            const code = document.getElementById('modificationCodeInput').value;
            
            if (!confirm(currentLang === 'fr'
                ? '‚ö†Ô∏è Supprimer l\'ensemble du groupe de cette chambre et se r√©inscrire dans une autre ?'
                : '‚ö†Ô∏è Delete the entire group from this room and re-register in another?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/modify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: roomToModify, code })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                hideModal('modificationModal');
                
                const container = document.getElementById('memberInputs');
                container.innerHTML = result.groupMembers.map((m, i) => `
                    <div class="member-row">
                        <select class="member-select" onchange="updateMemberSelects()">
                            <option value="">-- ${t('chooseParticipant')} --</option>
                            ${getAvailableParticipants().map(p => `
                                <option value="${p}" ${p === m ? 'selected' : ''}>${p}</option>
                            `).join('')}
                        </select>
                        ${i > 0 ? '<button class="btn btn-danger" onclick="removeMemberRow(this)">üóëÔ∏è</button>' : ''}
                    </div>
                `).join('');

                renderApp();
                alert(currentLang === 'fr'
                    ? `Groupe retir√© de la chambre n¬∞${roomToModify}.\nVous pouvez maintenant choisir une nouvelle chambre.`
                    : `Group removed from room #${roomToModify}.\nYou can now choose a new room.`);
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        // Admin functions
        async function toggleAdminMode() {
            if (isAdmin) {
                isAdmin = false;
                renderApp();
            } else {
                showModal('adminLoginModal');
            }
        }

        function loginAdmin() {
            const password = document.getElementById('adminPasswordInput').value;
            if (password === 'adminlvp25') {
                isAdmin = true;
                hideModal('adminLoginModal');
                renderApp();
            } else {
                alert(currentLang === 'fr' ? 'Code incorrect !' : 'Incorrect code!');
            }
        }

        async function removeOccupant(roomId, occupant) {
            if (!confirm(currentLang === 'fr' ? `Retirer ${occupant} de cette chambre ?` : `Remove ${occupant} from this room?`)) return;

            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId, occupant, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        async function toggleFemaleOnly(roomId) {
            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/toggle-female', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                const participants = lines.slice(1).map(line => {
                    const cols = line.split(/[,;\t]/);
                    return cols[0]?.trim();
                }).filter(name => name && name.length > 0);
                
                // Check capacity
                if (participants.length > appData.totalCapacity) {
                    alert(currentLang === 'fr'
                        ? `‚ö†Ô∏è ATTENTION : Vous importez ${participants.length} participants mais la capacit√© totale est de ${appData.totalCapacity} lits.\n\nIl manque ${participants.length - appData.totalCapacity} places !`
                        : `‚ö†Ô∏è WARNING: You are importing ${participants.length} participants but the total capacity is ${appData.totalCapacity} beds.\n\n${participants.length - appData.totalCapacity} places are missing!`);
                }

                const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
                
                try {
                    const response = await fetch('/api/admin/upload-participants', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ participants, password })
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        alert(result.error);
                        return;
                    }

                    appData = result.data;
                    renderApp();
                    alert(currentLang === 'fr' 
                        ? `${participants.length} participants import√©s !` 
                        : `${participants.length} participants imported!`);
                } catch (error) {
                    alert('Erreur : ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function exportResults() {
            let csv = 'Chambre,Type,Capacit√©,Occupants,Femmes Seulement,Pr√©f√©rence\n';
            appData.rooms.forEach(room => {
                csv += `${room.id},${room.type},${room.capacity},"${room.occupants.join('; ')}",${room.isFemaleOnly ? 'Oui' : 'Non'},${room.genderPreference}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'attributions_chambres.csv';
            a.click();
        }

        // UI helpers
        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function addMemberInput() {
            const container = document.getElementById('memberInputs');
            const div = document.createElement('div');
            div.className = 'member-row';
            div.innerHTML = `
                <select class="member-select" onchange="updateMemberSelects()">
                    <option value="">-- ${t('chooseParticipant')} --</option>
                    ${getAvailableParticipants().map(p => `
                        <option value="${p}">${p}</option>
                    `).join('')}
                </select>
                <button class="btn btn-danger" onclick="removeMemberRow(this)">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        }

        function removeMemberRow(btn) {
            btn.parentElement.remove();
            updateMemberSelects();
        }

        function getAvailableParticipants() {
            const assignedParticipants = new Set();
            appData.rooms.forEach(room => {
                room.occupants.forEach(occupant => assignedParticipants.add(occupant));
            });
            return appData.participants.filter(p => !assignedParticipants.has(p));
        }

        function updateMemberSelects() {
            const selects = document.querySelectorAll('.member-select');
            const available = getAvailableParticipants();
            
            selects.forEach(select => {
                const currentValue = select.value;
                const selectedValues = Array.from(selects)
                    .map(s => s.value)
                    .filter(v => v && v !== currentValue);

                select.innerHTML = `
                    <option value="">-- ${t('chooseParticipant')} --</option>
                    ${available.filter(p => !selectedValues.includes(p)).map(p => `
                        <option value="${p}" ${p === currentValue ? 'selected' : ''}>${p}</option>
                    `).join('')}
                `;
            });
        }

        // Admin participant management
        function addParticipant() {
            const name = prompt(currentLang === 'fr' ? 'Nom du nouveau participant :' : 'New participant name:');
            if (!name || !name.trim()) return;

            if (appData.participants.includes(name.trim())) {
                alert(currentLang === 'fr' ? 'Ce participant existe d√©j√† !' : 'This participant already exists!');
                return;
            }

            appData.participants.push(name.trim());
            appData.participants.sort();
            saveParticipants();
        }

        function editParticipant(oldName, index) {
            const newName = prompt(currentLang === 'fr' ? 'Modifier le nom :' : 'Edit name:', oldName);
            if (!newName || !newName.trim() || newName === oldName) return;

            if (appData.participants.includes(newName.trim())) {
                alert(currentLang === 'fr' ? 'Ce nom existe d√©j√† !' : 'This name already exists!');
                return;
            }

            const isAssigned = appData.rooms.some(r => r.occupants.includes(oldName));
            if (isAssigned) {
                if (!confirm(currentLang === 'fr'
                    ? `‚ö†Ô∏è ${oldName} est d√©j√† inscrit dans une chambre.\nLe modifier mettra √† jour son inscription automatiquement. Continuer ?`
                    : `‚ö†Ô∏è ${oldName} is already registered in a room.\nModifying will update their registration automatically. Continue?`)) {
                    return;
                }
            }

            editParticipantInDB(oldName, newName.trim());
        }

        async function editParticipantInDB(oldName, newName) {
            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/edit-participant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldName, newName, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    loadData();
                    return;
                }

                appData = result.data;
                alert(currentLang === 'fr' ? '‚úÖ Participant modifi√© !' : '‚úÖ Participant updated!');
                renderApp();
            } catch (error) {
                alert('Erreur : ' + error.message);
                loadData();
            }
        }

        function deleteParticipant(name, index) {
            const isAssigned = appData.rooms.some(r => r.occupants.includes(name));
            
            let confirmMsg = currentLang === 'fr' ? `Supprimer ${name} de la liste ?` : `Delete ${name} from the list?`;
            if (isAssigned) {
                confirmMsg = currentLang === 'fr'
                    ? `‚ö†Ô∏è ${name} est inscrit(e) dans une chambre.\n\nSupprimer le/la de la liste le/la retirera automatiquement de sa chambre.\n\nContinuer ?`
                    : `‚ö†Ô∏è ${name} is registered in a room.\n\nDeleting from the list will automatically remove them from their room.\n\nContinue?`;
            }

            if (!confirm(confirmMsg)) return;

            deleteParticipantFromDB(name);
        }

        async function deleteParticipantFromDB(name) {
            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/delete-participant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    loadData();
                    return;
                }

                appData = result.data;
                alert(currentLang === 'fr' ? '‚úÖ Participant supprim√© !' : '‚úÖ Participant deleted!');
                renderApp();
            } catch (error) {
                alert('Erreur : ' + error.message);
                loadData();
            }
        }

        async function clearAllParticipants() {
            if (!confirm(currentLang === 'fr'
                ? '‚ö†Ô∏è ATTENTION : √ätes-vous s√ªr de vouloir effacer toute la liste des participants ?\n\nCette action est irr√©versible !'
                : '‚ö†Ô∏è WARNING: Are you sure you want to clear the entire participants list?\n\nThis action is irreversible!')) {
                return;
            }

            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/clear-participants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
                alert(currentLang === 'fr' ? 'Liste effac√©e !' : 'List cleared!');
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        async function saveParticipants() {
            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/update-participants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ participants: appData.participants, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    loadData();
                    return;
                }

                appData = result.data;
                alert(currentLang === 'fr' ? '‚úÖ Liste des participants sauvegard√©e !' : '‚úÖ Participants list saved!');
                renderApp();
            } catch (error) {
                alert('Erreur : ' + error.message);
                loadData();
            }
        }

        async function clearRoom(roomId) {
            if (!confirm(currentLang === 'fr'
                ? `‚ö†Ô∏è Vider compl√®tement la chambre n¬∞${roomId} ?\n\nTous les occupants seront retir√©s.`
                : `‚ö†Ô∏è Clear room #${roomId} completely?\n\nAll occupants will be removed.`)) {
                return;
            }

            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/clear-room', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                renderApp();
                alert(currentLang === 'fr' ? '‚úÖ Chambre vid√©e !' : '‚úÖ Room cleared!');
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        // Room configuration
        function showRoomConfig() {
            showModal('roomConfigModal');
        }

        function saveRoomConfig() {
            const inputs = document.querySelectorAll('.room-config-row');
            const rooms = [];
            const roomIds = new Set();

            for (let input of inputs) {
                const id = input.querySelector('.room-id').value.trim();
                const capacity = parseInt(input.querySelector('.room-capacity').value);
                const type = input.querySelector('.room-type').value;

                if (!id) {
                    alert(currentLang === 'fr' ? 'Tous les num√©ros de chambre doivent √™tre renseign√©s' : 'All room numbers must be filled');
                    return;
                }

                if (roomIds.has(id)) {
                    alert(currentLang === 'fr' ? `Le num√©ro de chambre "${id}" est utilis√© plusieurs fois !` : `Room number "${id}" is used multiple times!`);
                    return;
                }

                roomIds.add(id);

                if (!capacity || capacity < 1) {
                    alert(currentLang === 'fr' ? 'Toutes les capacit√©s doivent √™tre sup√©rieures √† 0' : 'All capacities must be greater than 0');
                    return;
                }

                rooms.push({ id, capacity, type: type || `${capacity} lits` });
            }

            if (rooms.length === 0) {
                alert(currentLang === 'fr' ? 'Au moins une chambre est n√©cessaire' : 'At least one room is required');
                return;
            }

            if (!confirm(currentLang === 'fr'
                ? `‚ö†Ô∏è Vous allez remplacer la configuration des chambres.\n\n${rooms.length} chambres, capacit√© totale: ${rooms.reduce((sum, r) => sum + r.capacity, 0)} lits.\n\nContinuer ?`
                : `‚ö†Ô∏è You will replace the room configuration.\n\n${rooms.length} rooms, total capacity: ${rooms.reduce((sum, r) => sum + r.capacity, 0)} beds.\n\nContinue?`)) {
                return;
            }

            updateRoomsInDB(rooms);
        }

        async function updateRoomsInDB(rooms) {
            const password = prompt(currentLang === 'fr' ? 'Code admin :' : 'Admin code:');
            
            try {
                const response = await fetch('/api/admin/update-rooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rooms, password })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert(result.error);
                    return;
                }

                appData = result.data;
                hideModal('roomConfigModal');
                renderApp();
                alert(currentLang === 'fr' ? '‚úÖ Configuration des chambres mise √† jour !' : '‚úÖ Room configuration updated!');
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        function generateRoomConfigHTML() {
            const grouped = {};
            appData.rooms.forEach(room => {
                const key = `${room.capacity} lits`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(room.id);
            });

            let html = '<div style="margin-bottom: 20px;">';
            html += '<h3 style="margin-bottom: 10px;">' + (currentLang === 'fr' ? 'Configuration actuelle :' : 'Current configuration:') + '</h3>';
            html += '<table><thead><tr><th>' + (currentLang === 'fr' ? 'Type' : 'Type') + '</th><th>' + (currentLang === 'fr' ? 'Nombre' : 'Count') + '</th><th>' + (currentLang === 'fr' ? 'Num√©ros' : 'Numbers') + '</th></tr></thead><tbody>';
            
            Object.entries(grouped).forEach(([type, ids]) => {
                html += `<tr><td>${type}</td><td>${ids.length}</td><td>${ids.join(', ')}</td></tr>`;
            });
            
            html += '</tbody></table></div>';

            // Quick add section
            html += '<div style="margin-bottom: 30px; padding: 20px; background: #f0f4ff; border-radius: 8px;">';
            html += '<h3 style="margin-bottom: 15px;">' + (currentLang === 'fr' ? '‚ö° Ajout rapide de chambres' : '‚ö° Quick add rooms') + '</h3>';
            html += '<p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">' + (currentLang === 'fr' 
                ? 'G√©n√©rez automatiquement plusieurs chambres avec num√©rotation provisoire (modifiable ensuite)'
                : 'Automatically generate multiple rooms with temporary numbering (editable afterwards)') + '</p>';
            
            // Table header
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; font-weight: 600; padding: 8px; background: #e0e7ff; border-radius: 6px;">';
            html += `<div>${currentLang === 'fr' ? 'Capacit√© de la chambre' : 'Room capacity'}</div>`;
            html += `<div>${currentLang === 'fr' ? 'Nombre de chambres' : 'Number of rooms'}</div>`;
            html += '</div>';
            
            html += '<div id="quickAddContainer">';
            html += '<div class="quick-add-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;">';
            html += `<input type="number" class="quick-capacity" min="1" value="2" placeholder="${currentLang === 'fr' ? 'Ex: 2' : 'E.g.: 2'}" style="padding: 10px;">`;
            html += `<input type="number" class="quick-count" min="1" value="1" placeholder="${currentLang === 'fr' ? 'Ex: 5' : 'E.g.: 5'}" style="padding: 10px;">`;
            html += '<button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">üóëÔ∏è</button>';
            html += '</div>';
            html += '</div>';
            
            html += '<div style="display: flex; gap: 10px; margin-top: 15px;">';
            html += '<button class="btn btn-primary" onclick="addQuickAddRow()">' + (currentLang === 'fr' ? '‚ûï Ajouter un groupe de chambres' : '‚ûï Add a group of rooms') + '</button>';
            html += '<button class="btn btn-success" onclick="quickAddRooms()">' + (currentLang === 'fr' ? '‚ú® G√©n√©rer ces chambres' : '‚ú® Generate these rooms') + '</button>';
            html += '</div>';
            html += '</div>';

            html += '<div style="margin-bottom: 20px;"><h3>' + (currentLang === 'fr' ? 'Modifier la configuration :' : 'Edit configuration:') + '</h3>';
            
            // Table header for room config
            html += '<div style="display: grid; grid-template-columns: 100px 100px 1fr auto; gap: 10px; margin-bottom: 10px; font-weight: 600; padding: 8px; background: #f3f4f6; border-radius: 6px;">';
            html += `<div>${currentLang === 'fr' ? 'N¬∞ chambre' : 'Room #'}</div>`;
            html += `<div>${currentLang === 'fr' ? 'Capacit√©' : 'Capacity'}</div>`;
            html += `<div>${currentLang === 'fr' ? 'Type (lits double, lits individuels...)' : 'Type (double beds, single beds...)'}</div>`;
            html += `<div></div>`;
            html += '</div>';
            
            html += '<div id="roomConfigList">';
            
            appData.rooms.forEach(room => {
                html += `
                    <div class="room-config-row" style="display: grid; grid-template-columns: 100px 100px 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <input type="text" class="room-id" value="${room.id}" placeholder="${currentLang === 'fr' ? 'Ex: A1' : 'E.g.: A1'}">
                        <input type="number" class="room-capacity" value="${room.capacity}" min="1" placeholder="${currentLang === 'fr' ? 'Ex: 2' : 'E.g.: 2'}">
                        <input type="text" class="room-type" value="${room.type}" placeholder="${currentLang === 'fr' ? 'Optionnel' : 'Optional'}">
                        <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div style="display: flex; gap: 10px; margin-top: 10px;">';
            html += '<button class="btn btn-primary" onclick="addRoomConfigRow()">' + (currentLang === 'fr' ? '‚ûï Ajouter une chambre' : '‚ûï Add a room') + '</button>';
            html += '<button class="btn btn-danger" onclick="clearAllRooms()">' + (currentLang === 'fr' ? 'üóëÔ∏è Supprimer toutes les chambres' : 'üóëÔ∏è Delete all rooms') + '</button>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        function addQuickAddRow() {
            const container = document.getElementById('quickAddContainer');
            const div = document.createElement('div');
            div.className = 'quick-add-row';
            div.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;';
            div.innerHTML = `
                <input type="number" class="quick-capacity" min="1" value="2" placeholder="${currentLang === 'fr' ? 'Ex: 2' : 'E.g.: 2'}" style="padding: 10px;">
                <input type="number" class="quick-count" min="1" value="1" placeholder="${currentLang === 'fr' ? 'Ex: 5' : 'E.g.: 5'}" style="padding: 10px;">
                <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        }

        function quickAddRooms() {
            const rows = document.querySelectorAll('.quick-add-row');
            let newRooms = [];
            let nextRoomNumber = 1;

            // Get existing max room number
            appData.rooms.forEach(room => {
                const num = parseInt(room.id);
                if (!isNaN(num) && num >= nextRoomNumber) {
                    nextRoomNumber = num + 1;
                }
            });

            rows.forEach(row => {
                const capacity = parseInt(row.querySelector('.quick-capacity').value) || 0;
                const count = parseInt(row.querySelector('.quick-count').value) || 0;
                
                if (capacity > 0 && count > 0) {
                    for (let i = 0; i < count; i++) {
                        newRooms.push({
                            id: `${nextRoomNumber}`,
                            capacity: capacity,
                            type: `${capacity} ${currentLang === 'fr' ? 'lits' : 'beds'}`
                        });
                        nextRoomNumber++;
                    }
                }
            });

            if (newRooms.length === 0) {
                alert(currentLang === 'fr' ? 'Aucune chambre √† ajouter' : 'No rooms to add');
                return;
            }

            const summary = {};
            newRooms.forEach(r => {
                const key = `${r.capacity} ${currentLang === 'fr' ? 'lits' : 'beds'}`;
                summary[key] = (summary[key] || 0) + 1;
            });

            const summaryText = Object.entries(summary).map(([type, count]) => `${count} √ó ${type}`).join('\n');

            if (!confirm(currentLang === 'fr'
                ? `Ajouter ${newRooms.length} nouvelles chambres ?\n\n${summaryText}\n\nNum√©rotation de ${newRooms[0].id} √† ${newRooms[newRooms.length-1].id}`
                : `Add ${newRooms.length} new rooms?\n\n${summaryText}\n\nNumbering from ${newRooms[0].id} to ${newRooms[newRooms.length-1].id}`)) {
                return;
            }

            // Add to existing rooms
            const allRooms = [...appData.rooms, ...newRooms];
            updateRoomsInDB(allRooms);
        }

        function clearAllRooms() {
            if (!confirm(currentLang === 'fr'
                ? '‚ö†Ô∏è ATTENTION : Supprimer TOUTES les chambres ?\n\nCette action supprimera aussi toutes les inscriptions !\n\n√ätes-vous absolument s√ªr ?'
                : '‚ö†Ô∏è WARNING: Delete ALL rooms?\n\nThis will also delete all registrations!\n\nAre you absolutely sure?')) {
                return;
            }

            if (!confirm(currentLang === 'fr'
                ? '‚ö†Ô∏è DERNI√àRE CONFIRMATION : Cette action est irr√©versible !'
                : '‚ö†Ô∏è FINAL CONFIRMATION: This action is irreversible!')) {
                return;
            }

            updateRoomsInDB([]);
        }

        function addRoomConfigRow() {
            const container = document.getElementById('roomConfigList');
            const div = document.createElement('div');
            div.className = 'room-config-row';
            div.style.cssText = 'display: grid; grid-template-columns: 100px 100px 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;';
            div.innerHTML = `
                <input type="text" class="room-id" placeholder="${currentLang === 'fr' ? 'Ex: A1' : 'E.g.: A1'}">
                <input type="number" class="room-capacity" value="2" min="1" placeholder="${currentLang === 'fr' ? 'Ex: 2' : 'E.g.: 2'}">
                <input type="text" class="room-type" placeholder="${currentLang === 'fr' ? 'Optionnel' : 'Optional'}">
                <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        }

        // Render
        function renderApp() {
